import React, { useState, useEffect } from 'react';
import {
  Container,
  Paper,
  Typography,
  Button,
  Box,
  Card,
  CardContent,
  Alert,
  CircularProgress,
  Divider
} from '@mui/material';
import {
  TableChart as ExcelIcon,
  PictureAsPdf as PdfIcon,
  CheckCircle as CheckIcon,
  Refresh as RefreshIcon
} from '@mui/icons-material';
import { ExportService } from '../services/ExportService';

const ExportTestFinal: React.FC = () => {
  const [exportStatus, setExportStatus] = useState<string>('');
  const [loading, setLoading] = useState<boolean>(false);
  const [realData, setRealData] = useState<{
    workers: any[];
    absences: any[];
    leaves: any[];
  }>({
    workers: [],
    absences: [],
    leaves: []
  });

  // ุฌูุจ ุงูุจูุงูุงุช ุงูุญููููุฉ ูู API
  const fetchRealData = async () => {
    setLoading(true);
    try {
      const [workersRes, absencesRes, leavesRes] = await Promise.all([
        fetch('http://localhost:8000/workers/public'),
        fetch('http://localhost:8000/absences'),
        fetch('http://localhost:8000/leaves')
      ]);

      const [workersData, absencesData, leavesData] = await Promise.all([
        workersRes.json(),
        absencesRes.json(),
        leavesRes.json()
      ]);

      setRealData({
        workers: workersData || [],
        absences: absencesData || [],
        leaves: leavesData || []
      });
    } catch (error) {
      console.error('Error fetching data:', error);
      setExportStatus('โ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchRealData();
  }, []);

  // ุงูุชุนุฑููุงุช ููุฃุนูุฏุฉ
  const workersColumns = [
    { key: 'id', label: 'ุงูุฑูู' },
    { key: 'name', label: 'ุงุณู ุงูุนุงูู' },
    { key: 'civil_id', label: 'ุงูุฑูู ุงููุฏูู' },
    { key: 'nationality', label: 'ุงูุฌูุณูุฉ' },
    { key: 'job_title', label: 'ุงููุณูู ุงููุธููู' },
    { key: 'salary', label: 'ุงูุฑุงุชุจ', format: (value: number) => `${value || 0} ุฏ.ู` },
    { key: 'hire_date', label: 'ุชุงุฑูุฎ ุงูุชุนููู' },
    { key: 'phone', label: 'ุฑูู ุงููุงุชู' }
  ];

  const absencesColumns = [
    { key: 'id', label: 'ุงูุฑูู' },
    { key: 'worker_name', label: 'ุงุณู ุงูุนุงูู' },
    { key: 'absence_date', label: 'ุชุงุฑูุฎ ุงูุบูุงุจ' },
    { key: 'reason', label: 'ุงูุณุจุจ' },
    { key: 'status', label: 'ุงูุญุงูุฉ' }
  ];

  const leavesColumns = [
    { key: 'id', label: 'ุงูุฑูู' },
    { key: 'worker_name', label: 'ุงุณู ุงูุนุงูู' },
    { key: 'leave_type', label: 'ููุน ุงูุฅุฌุงุฒุฉ' },
    { key: 'start_date', label: 'ุชุงุฑูุฎ ุงูุจุฏุงูุฉ' },
    { key: 'end_date', label: 'ุชุงุฑูุฎ ุงูููุงูุฉ' },
    { key: 'status', label: 'ุงูุญุงูุฉ' }
  ];

  // ูุธุงุฆู ุงูุชุตุฏูุฑ
  const handleExportWorkersExcel = () => {
    try {
      ExportService.exportToExcel(realData.workers, workersColumns, {
        format: 'excel',
        filename: `workers_${new Date().toISOString().split('T')[0]}.xlsx`,
        title: 'ุจูุงูุงุช ุงูุนูุงู',
        includeDate: true,
        includeStats: true
      });
      setExportStatus(`โ ุชู ุชุตุฏูุฑ ${realData.workers.length} ุนุงูู ุฅูู Excel ุจูุฌุงุญ!`);
    } catch (error) {
      setExportStatus(`โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุนูุงู: ${error}`);
    }
  };

  const handleExportWorkersPDF = () => {
    try {
      ExportService.exportToPDF(realData.workers, workersColumns, {
        format: 'pdf',
        filename: `workers_${new Date().toISOString().split('T')[0]}.pdf`,
        title: 'ุชูุฑูุฑ ุจูุงูุงุช ุงูุนูุงู',
        includeDate: true,
        includeStats: true,
        rtl: true
      });
      setExportStatus(`โ ุชู ุชุตุฏูุฑ ${realData.workers.length} ุนุงูู ุฅูู PDF ุจูุฌุงุญ!`);
    } catch (error) {
      setExportStatus(`โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุนูุงู: ${error}`);
    }
  };

  const handleExportAbsencesExcel = () => {
    try {
      ExportService.exportToExcel(realData.absences, absencesColumns, {
        format: 'excel',
        filename: `absences_${new Date().toISOString().split('T')[0]}.xlsx`,
        title: 'ุจูุงูุงุช ุงูุบูุงุจุงุช',
        includeDate: true,
        includeStats: true
      });
      setExportStatus(`โ ุชู ุชุตุฏูุฑ ${realData.absences.length} ุณุฌู ุบูุงุจ ุฅูู Excel ุจูุฌุงุญ!`);
    } catch (error) {
      setExportStatus(`โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุบูุงุจุงุช: ${error}`);
    }
  };

  const handleExportLeavesPDF = () => {
    try {
      ExportService.exportToPDF(realData.leaves, leavesColumns, {
        format: 'pdf',
        filename: `leaves_${new Date().toISOString().split('T')[0]}.pdf`,
        title: 'ุชูุฑูุฑ ุงูุฅุฌุงุฒุงุช',
        includeDate: true,
        includeStats: true,
        rtl: true
      });
      setExportStatus(`โ ุชู ุชุตุฏูุฑ ${realData.leaves.length} ุฅุฌุงุฒุฉ ุฅูู PDF ุจูุฌุงุญ!`);
    } catch (error) {
      setExportStatus(`โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุฅุฌุงุฒุงุช: ${error}`);
    }
  };

  return (
    <Container maxWidth="lg" sx={{ mt: 4, mb: 4 }}>
      <Paper sx={{ p: 3 }}>
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
          <Typography variant="h4" component="h1">
            ๐งช ุงุฎุชุจุงุฑ ููุฒุงุช ุงูุชุตุฏูุฑ ุงููุญุณู
          </Typography>
          <Button
            variant="outlined"
            startIcon={<RefreshIcon />}
            onClick={fetchRealData}
            disabled={loading}
          >
            ุชุญุฏูุซ ุงูุจูุงูุงุช
          </Button>
        </Box>
        
        <Typography variant="body1" color="text.secondary" paragraph>
          ุงุฎุชุจุงุฑ ุชุตุฏูุฑ ุงูุจูุงูุงุช ุงูุญููููุฉ ุฅูู Excel ู PDF ูุน ุงูุฎุทูุท ุงูุนุฑุจูุฉ ุงููุญุณูุฉ
        </Typography>

        {loading && (
          <Box display="flex" justifyContent="center" alignItems="center" my={4}>
            <CircularProgress />
            <Typography variant="body2" sx={{ ml: 2 }}>
              ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...
            </Typography>
          </Box>
        )}

        {/* ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช */}
        <Box display="flex" gap={2} mb={3} flexWrap="wrap">
          <Card sx={{ minWidth: 200 }}>
            <CardContent>
              <Box display="flex" alignItems="center">
                <CheckIcon color="primary" sx={{ mr: 1 }} />
                <Typography variant="h6">ุงูุนูุงู</Typography>
              </Box>
              <Typography variant="h4" color="primary">
                {realData.workers.length}
              </Typography>
              <Typography variant="body2" color="text.secondary">
                ุนุงูู ูุชุงุญ
              </Typography>
            </CardContent>
          </Card>

          <Card sx={{ minWidth: 200 }}>
            <CardContent>
              <Box display="flex" alignItems="center">
                <CheckIcon color="warning" sx={{ mr: 1 }} />
                <Typography variant="h6">ุงูุบูุงุจุงุช</Typography>
              </Box>
              <Typography variant="h4" color="warning.main">
                {realData.absences.length}
              </Typography>
              <Typography variant="body2" color="text.secondary">
                ุณุฌู ุบูุงุจ
              </Typography>
            </CardContent>
          </Card>

          <Card sx={{ minWidth: 200 }}>
            <CardContent>
              <Box display="flex" alignItems="center">
                <CheckIcon color="success" sx={{ mr: 1 }} />
                <Typography variant="h6">ุงูุฅุฌุงุฒุงุช</Typography>
              </Box>
              <Typography variant="h4" color="success.main">
                {realData.leaves.length}
              </Typography>
              <Typography variant="body2" color="text.secondary">
                ุฅุฌุงุฒุฉ ูุณุฌูุฉ
              </Typography>
            </CardContent>
          </Card>
        </Box>

        <Divider sx={{ my: 3 }} />

        {/* ุฃุฒุฑุงุฑ ุงูุชุตุฏูุฑ */}
        <Typography variant="h5" gutterBottom>
          ๐ ุชุตุฏูุฑ ุงูุจูุงูุงุช ุงูุญููููุฉ
        </Typography>

        <Box display="flex" flexDirection="column" gap={3}>
          {/* ุชุตุฏูุฑ ุงูุนูุงู */}
          <Card>
            <CardContent>
              <Typography variant="h6" gutterBottom>
                ๐ฅ ุจูุงูุงุช ุงูุนูุงู ({realData.workers.length} ุนุงูู)
              </Typography>
              <Box display="flex" gap={2} flexWrap="wrap">
                <Button
                  variant="contained"
                  startIcon={<ExcelIcon />}
                  onClick={handleExportWorkersExcel}
                  disabled={realData.workers.length === 0}
                  color="success"
                >
                  ุชุตุฏูุฑ Excel
                </Button>
                <Button
                  variant="contained"
                  startIcon={<PdfIcon />}
                  onClick={handleExportWorkersPDF}
                  disabled={realData.workers.length === 0}
                  color="error"
                >
                  ุชุตุฏูุฑ PDF
                </Button>
              </Box>
            </CardContent>
          </Card>

          {/* ุชุตุฏูุฑ ุงูุบูุงุจุงุช */}
          <Card>
            <CardContent>
              <Typography variant="h6" gutterBottom>
                โ๏ธ ุจูุงูุงุช ุงูุบูุงุจุงุช ({realData.absences.length} ุณุฌู)
              </Typography>
              <Box display="flex" gap={2} flexWrap="wrap">
                <Button
                  variant="contained"
                  startIcon={<ExcelIcon />}
                  onClick={handleExportAbsencesExcel}
                  disabled={realData.absences.length === 0}
                  color="success"
                >
                  ุชุตุฏูุฑ Excel
                </Button>
                <Button
                  variant="outlined"
                  startIcon={<PdfIcon />}
                  disabled={realData.absences.length === 0}
                  color="error"
                >
                  ุชุตุฏูุฑ PDF
                </Button>
              </Box>
            </CardContent>
          </Card>

          {/* ุชุตุฏูุฑ ุงูุฅุฌุงุฒุงุช */}
          <Card>
            <CardContent>
              <Typography variant="h6" gutterBottom>
                ๐๏ธ ุจูุงูุงุช ุงูุฅุฌุงุฒุงุช ({realData.leaves.length} ุฅุฌุงุฒุฉ)
              </Typography>
              <Box display="flex" gap={2} flexWrap="wrap">
                <Button
                  variant="outlined"
                  startIcon={<ExcelIcon />}
                  disabled={realData.leaves.length === 0}
                  color="success"
                >
                  ุชุตุฏูุฑ Excel
                </Button>
                <Button
                  variant="contained"
                  startIcon={<PdfIcon />}
                  onClick={handleExportLeavesPDF}
                  disabled={realData.leaves.length === 0}
                  color="error"
                >
                  ุชุตุฏูุฑ PDF
                </Button>
              </Box>
            </CardContent>
          </Card>
        </Box>

        {/* ุญุงูุฉ ุงูุชุตุฏูุฑ */}
        {exportStatus && (
          <Alert 
            severity={exportStatus.includes('โ') ? 'success' : 'error'} 
            sx={{ mt: 3 }}
            onClose={() => setExportStatus('')}
          >
            {exportStatus}
          </Alert>
        )}

        {/* ูุนูููุงุช ุฅุถุงููุฉ */}
        <Box sx={{ mt: 4, p: 2, bgcolor: 'grey.50', borderRadius: 1 }}>
          <Typography variant="h6" gutterBottom>
            โน๏ธ ุชุญุณููุงุช ุงูุชุตุฏูุฑ ุงูุฌุฏูุฏุฉ
          </Typography>
          <Typography variant="body2" paragraph>
            โ ุชู ุชุญุณูู ุชุตุฏูุฑ PDF ูุฏุนู ุงููุตูุต ุงูุนุฑุจูุฉ ุจุดูู ุฃูุถู
          </Typography>
          <Typography variant="body2" paragraph>
            โ ูุชู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุฎุงุฏู ูุจุงุดุฑุฉ ูุน {realData.workers.length + realData.absences.length + realData.leaves.length} ุนูุตุฑ
          </Typography>
          <Typography variant="body2" paragraph>
            โ ุงููููุงุช ุงููุตุฏุฑุฉ ุชุชุถูู ุงูุชุงุฑูุฎ ูุงูุฅุญุตุงุฆูุงุช ูุงูุชูุณูู ุงูุนุฑุจู
          </Typography>
          <Typography variant="body2">
            โ ุชู ุฅุถุงูุฉ ุงูุฎุทูุท ุงูุนุฑุจูุฉ ูุชุญุณูู ุงุชุฌุงู ุงููุต (RTL)
          </Typography>
        </Box>
      </Paper>
    </Container>
  );
};

export default ExportTestFinal;
