<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إعدادات الأمان - إدارة العمال</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .security-gradient { background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); }
        .security-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .security-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .security-enabled {
            border-color: #10b981;
            background: linear-gradient(45deg, #ecfdf5, #f0fdf4);
        }
        .security-disabled {
            border-color: #ef4444;
            background: linear-gradient(45deg, #fef2f2, #fef2f2);
        }
        .qr-code-container {
            max-width: 200px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="security-gradient text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-reverse space-x-4">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                    <h1 class="text-2xl font-bold">إعدادات الأمان</h1>
                </div>
                <div class="flex items-center space-x-reverse space-x-4">
                    <span class="text-sm opacity-80">آخر تحديث: منذ دقيقتين</span>
                    <button class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Security Status Bar -->
    <div class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-reverse space-x-6">
                    <div class="flex items-center">
                        <div id="securityStatusIcon" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse ml-2"></div>
                        <span id="securityStatusText" class="text-sm text-gray-700">جاري تقييم الأمان...</span>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="lock" class="w-4 h-4 text-blue-600 ml-2"></i>
                        <span class="text-sm text-gray-700">مستوى الأمان: <span id="securityLevel">متوسط</span></span>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">SSL محمي</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Security Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Two-Factor Authentication -->
            <div id="twoFactorCard" class="security-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="twoFactorToggle" class="toggle-switch" onchange="toggleTwoFactor()">
                        <label for="twoFactorToggle" class="ml-2 text-sm font-medium">تفعيل</label>
                    </div>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">المصادقة الثنائية</h3>
                <p class="text-gray-600 text-sm mb-3">طبقة أمان إضافية لحماية حسابك</p>
                <div id="twoFactorStatus" class="text-sm">
                    <span class="text-red-600">غير مفعل</span>
                </div>
            </div>

            <!-- Password Security -->
            <div class="security-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-green-100 rounded-full">
                        <i data-lucide="key" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <button onclick="showPasswordChange()" class="text-blue-600 text-sm hover:underline">تغيير</button>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">كلمة المرور</h3>
                <p class="text-gray-600 text-sm mb-3">قوة كلمة المرور الحالية</p>
                <div class="flex items-center">
                    <div class="w-full bg-gray-200 rounded-full h-2 ml-2">
                        <div id="passwordStrengthBar" class="bg-yellow-500 h-2 rounded-full" style="width: 60%"></div>
                    </div>
                    <span id="passwordStrength" class="text-sm text-yellow-600">متوسط</span>
                </div>
            </div>

            <!-- Security Logs -->
            <div class="security-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i data-lucide="file-text" class="w-6 h-6 text-purple-600"></i>
                    </div>
                    <button onclick="showSecurityLogs()" class="text-blue-600 text-sm hover:underline">عرض الكل</button>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">سجل الأمان</h3>
                <p class="text-gray-600 text-sm mb-3">آخر الأنشطة الأمنية</p>
                <div class="text-sm text-gray-500">
                    <span>آخر تسجيل دخول: اليوم 2:30 ص</span>
                </div>
            </div>
        </div>

        <!-- Main Security Settings -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Two-Factor Authentication Setup -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="smartphone" class="w-6 h-6 text-blue-600 ml-3"></i>
                    <h3 class="text-xl font-semibold text-gray-800">إعداد المصادقة الثنائية</h3>
                </div>

                <div id="twoFactorSetup" class="space-y-6">
                    <!-- Step 1: Password Verification -->
                    <div id="step1" class="space-y-4">
                        <div class="bg-blue-50 border-r-4 border-blue-500 p-4 rounded">
                            <div class="flex items-center">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 ml-2"></i>
                                <p class="text-blue-800 text-sm">لتفعيل المصادقة الثنائية، يرجى إدخال كلمة المرور الحالية</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور الحالية</label>
                            <input type="password" id="currentPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <button onclick="verifyPasswordFor2FA()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            المتابعة
                        </button>
                    </div>

                    <!-- Step 2: QR Code -->
                    <div id="step2" class="space-y-4 hidden">
                        <div class="text-center">
                            <h4 class="font-semibold text-gray-800 mb-4">امسح رمز QR باستخدام تطبيق Google Authenticator</h4>
                            <div id="qrCodeContainer" class="qr-code-container mb-4">
                                <!-- QR Code will be displayed here -->
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg mb-4">
                                <p class="text-sm text-gray-600 mb-2">أو أدخل هذا المفتاح يدوياً:</p>
                                <code id="manualKey" class="bg-gray-200 px-2 py-1 rounded text-sm"></code>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رمز التحقق (6 أرقام)</label>
                            <input type="text" id="verificationCode" maxlength="6" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-2xl tracking-widest">
                        </div>

                        <button onclick="enableTwoFactor()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            تفعيل المصادقة الثنائية
                        </button>
                    </div>

                    <!-- Step 3: Backup Codes -->
                    <div id="step3" class="space-y-4 hidden">
                        <div class="bg-green-50 border-r-4 border-green-500 p-4 rounded">
                            <div class="flex items-center">
                                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 ml-2"></i>
                                <p class="text-green-800 text-sm">تم تفعيل المصادقة الثنائية بنجاح!</p>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">أكواد الاستعادة</h4>
                            <p class="text-sm text-gray-600 mb-3">احفظ هذه الأكواد في مكان آمن. يمكنك استخدامها للدخول إذا فقدت هاتفك:</p>
                            <div id="backupCodes" class="bg-gray-50 p-4 rounded-lg font-mono text-sm space-y-2">
                                <!-- Backup codes will be displayed here -->
                            </div>
                        </div>

                        <div class="flex space-x-reverse space-x-3">
                            <button onclick="downloadBackupCodes()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                تحميل الأكواد
                            </button>
                            <button onclick="printBackupCodes()" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                                طباعة
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Change -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="key" class="w-6 h-6 text-green-600 ml-3"></i>
                    <h3 class="text-xl font-semibold text-gray-800">تغيير كلمة المرور</h3>
                </div>

                <form id="passwordChangeForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور الحالية</label>
                        <input type="password" id="oldPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور الجديدة</label>
                        <input type="password" id="newPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500" oninput="checkPasswordStrength()">
                        <div class="mt-2">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2 ml-2">
                                    <div id="newPasswordStrengthBar" class="bg-red-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <span id="newPasswordStrength" class="text-sm text-gray-500">ضعيف</span>
                            </div>
                            <div id="passwordRequirements" class="mt-2 space-y-1 text-sm">
                                <!-- Password requirements will be shown here -->
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">تأكيد كلمة المرور الجديدة</label>
                        <input type="password" id="confirmPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500" oninput="checkPasswordMatch()">
                        <div id="passwordMatchMessage" class="mt-1 text-sm"></div>
                    </div>

                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        تحديث كلمة المرور
                    </button>
                </form>
            </div>
        </div>

        <!-- Security Logs Section -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i data-lucide="shield" class="w-6 h-6 text-purple-600 ml-3"></i>
                    <h3 class="text-xl font-semibold text-gray-800">سجل الأنشطة الأمنية</h3>
                </div>
                <button onclick="refreshSecurityLogs()" class="text-blue-600 hover:underline text-sm">
                    <i data-lucide="refresh-cw" class="w-4 h-4 inline ml-1"></i>
                    تحديث
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">النشاط</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">التاريخ والوقت</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">عنوان IP</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الجهاز</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="securityLogsTable" class="divide-y divide-gray-200">
                        <!-- Security logs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals and Loading States -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-reverse space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="text-lg">جاري المعالجة...</span>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // API Base URL
        const API_BASE = 'http://localhost:8000';

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            loadSecuritySettings();
            loadSecurityLogs();
            checkSecurityStatus();
        });

        // Load security settings
        async function loadSecuritySettings() {
            try {
                const response = await fetch(`${API_BASE}/security/settings`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const settings = await response.json();
                
                // Update UI based on settings
                updateSecurityUI(settings);
                
            } catch (error) {
                console.error('Error loading security settings:', error);
            }
        }

        // Update security UI
        function updateSecurityUI(settings) {
            const twoFactorToggle = document.getElementById('twoFactorToggle');
            const twoFactorCard = document.getElementById('twoFactorCard');
            const twoFactorStatus = document.getElementById('twoFactorStatus');
            
            twoFactorToggle.checked = settings.two_factor_enabled;
            
            if (settings.two_factor_enabled) {
                twoFactorCard.classList.add('security-enabled');
                twoFactorCard.classList.remove('security-disabled');
                twoFactorStatus.innerHTML = '<span class="text-green-600">مفعل ✓</span>';
            } else {
                twoFactorCard.classList.add('security-disabled');
                twoFactorCard.classList.remove('security-enabled');
                twoFactorStatus.innerHTML = '<span class="text-red-600">غير مفعل</span>';
            }
        }

        // Check overall security status
        function checkSecurityStatus() {
            // Sample implementation - calculate security score
            let securityScore = 0;
            let issues = [];
            
            const twoFactorEnabled = document.getElementById('twoFactorToggle').checked;
            if (twoFactorEnabled) securityScore += 40;
            else issues.push('المصادقة الثنائية غير مفعلة');
            
            // Check password strength (mock)
            const passwordStrength = 60; // Mock value
            securityScore += passwordStrength * 0.6;
            
            // Update security status
            const statusIcon = document.getElementById('securityStatusIcon');
            const statusText = document.getElementById('securityStatusText');
            const securityLevel = document.getElementById('securityLevel');
            
            if (securityScore >= 80) {
                statusIcon.className = 'w-3 h-3 bg-green-500 rounded-full ml-2';
                statusText.textContent = 'مستوى الأمان مرتفع';
                securityLevel.textContent = 'مرتفع';
                securityLevel.className = 'text-green-600 font-semibold';
            } else if (securityScore >= 60) {
                statusIcon.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse ml-2';
                statusText.textContent = 'مستوى الأمان متوسط';
                securityLevel.textContent = 'متوسط';
                securityLevel.className = 'text-yellow-600 font-semibold';
            } else {
                statusIcon.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse ml-2';
                statusText.textContent = 'مستوى الأمان منخفض';
                securityLevel.textContent = 'منخفض';
                securityLevel.className = 'text-red-600 font-semibold';
            }
        }

        // Two-Factor Authentication functions
        async function toggleTwoFactor() {
            const isEnabled = document.getElementById('twoFactorToggle').checked;
            
            if (isEnabled) {
                // Show setup process
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
            } else {
                // Disable 2FA
                if (confirm('هل أنت متأكد من إلغاء تفعيل المصادقة الثنائية؟')) {
                    await disableTwoFactor();
                } else {
                    document.getElementById('twoFactorToggle').checked = true;
                }
            }
        }

        async function verifyPasswordFor2FA() {
            const password = document.getElementById('currentPassword').value;
            
            if (!password) {
                alert('يرجى إدخال كلمة المرور');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/security/2fa/setup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show QR code
                    document.getElementById('qrCodeContainer').innerHTML = `<img src="data:image/png;base64,${data.qr_code}" alt="QR Code" class="w-full">`;
                    document.getElementById('manualKey').textContent = data.secret;
                    
                    // Move to step 2
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                } else {
                    alert(data.detail);
                }
            } catch (error) {
                alert('حدث خطأ في التحقق من كلمة المرور');
            } finally {
                showLoading(false);
            }
        }

        async function enableTwoFactor() {
            const token = document.getElementById('verificationCode').value;
            
            if (!token || token.length !== 6) {
                alert('يرجى إدخال رمز التحقق المكون من 6 أرقام');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/security/2fa/enable`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ 
                        token,
                        backup_codes: true 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show backup codes
                    const backupCodesContainer = document.getElementById('backupCodes');
                    backupCodesContainer.innerHTML = data.backup_codes.map(code => 
                        `<div class="p-2 bg-white rounded border">${code}</div>`
                    ).join('');
                    
                    // Move to step 3
                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('step3').classList.remove('hidden');
                    
                    // Update UI
                    updateSecurityUI({ two_factor_enabled: true });
                    checkSecurityStatus();
                } else {
                    alert(data.detail);
                }
            } catch (error) {
                alert('حدث خطأ في تفعيل المصادقة الثنائية');
            } finally {
                showLoading(false);
            }
        }

        async function disableTwoFactor() {
            const password = prompt('يرجى إدخال كلمة المرور لإلغاء تفعيل المصادقة الثنائية:');
            
            if (!password) return;
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/security/2fa/disable`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateSecurityUI({ two_factor_enabled: false });
                    checkSecurityStatus();
                    alert('تم إلغاء تفعيل المصادقة الثنائية');
                } else {
                    alert(data.detail);
                    document.getElementById('twoFactorToggle').checked = true;
                }
            } catch (error) {
                alert('حدث خطأ في إلغاء تفعيل المصادقة الثنائية');
                document.getElementById('twoFactorToggle').checked = true;
            } finally {
                showLoading(false);
            }
        }

        // Password change functions
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('newPasswordStrengthBar');
            const strengthText = document.getElementById('newPasswordStrength');
            const requirements = document.getElementById('passwordRequirements');
            
            let score = 0;
            let feedback = [];
            
            // Check requirements
            const checks = [
                { test: password.length >= 8, text: 'على الأقل 8 أحرف' },
                { test: /[A-Z]/.test(password), text: 'حرف كبير واحد على الأقل' },
                { test: /[a-z]/.test(password), text: 'حرف صغير واحد على الأقل' },
                { test: /\d/.test(password), text: 'رقم واحد على الأقل' },
                { test: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password), text: 'رمز خاص واحد على الأقل' }
            ];
            
            checks.forEach(check => {
                if (check.test) {
                    score += 20;
                    feedback.push(`<div class="flex items-center text-green-600"><i data-lucide="check" class="w-3 h-3 ml-1"></i>${check.text}</div>`);
                } else {
                    feedback.push(`<div class="flex items-center text-red-600"><i data-lucide="x" class="w-3 h-3 ml-1"></i>${check.text}</div>`);
                }
            });
            
            // Update UI
            strengthBar.style.width = `${score}%`;
            requirements.innerHTML = feedback.join('');
            
            if (score >= 80) {
                strengthBar.className = 'bg-green-500 h-2 rounded-full transition-all';
                strengthText.textContent = 'قوي';
                strengthText.className = 'text-sm text-green-600';
            } else if (score >= 60) {
                strengthBar.className = 'bg-yellow-500 h-2 rounded-full transition-all';
                strengthText.textContent = 'متوسط';
                strengthText.className = 'text-sm text-yellow-600';
            } else {
                strengthBar.className = 'bg-red-500 h-2 rounded-full transition-all';
                strengthText.textContent = 'ضعيف';
                strengthText.className = 'text-sm text-red-600';
            }
            
            lucide.createIcons();
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const message = document.getElementById('passwordMatchMessage');
            
            if (confirmPassword === '') {
                message.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                message.innerHTML = '<span class="text-green-600">✓ كلمات المرور متطابقة</span>';
            } else {
                message.innerHTML = '<span class="text-red-600">✗ كلمات المرور غير متطابقة</span>';
            }
        }

        // Password change form submission
        document.getElementById('passwordChangeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!oldPassword || !newPassword || !confirmPassword) {
                alert('يرجى ملء جميع الحقول');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('كلمات المرور الجديدة غير متطابقة');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/security/password/change`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        current_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('تم تحديث كلمة المرور بنجاح');
                    document.getElementById('passwordChangeForm').reset();
                    document.getElementById('passwordRequirements').innerHTML = '';
                    document.getElementById('passwordMatchMessage').textContent = '';
                } else {
                    if (data.detail && typeof data.detail === 'object') {
                        alert(data.detail.message + '\n' + data.detail.feedback.join('\n'));
                    } else {
                        alert(data.detail);
                    }
                }
            } catch (error) {
                alert('حدث خطأ في تحديث كلمة المرور');
            } finally {
                showLoading(false);
            }
        });

        // Security logs functions
        async function loadSecurityLogs() {
            try {
                // Mock data - replace with actual API call
                const logs = [
                    { action: 'تسجيل دخول', timestamp: '2024-01-15 14:30:00', ip: '192.168.1.100', device: 'Chrome Windows', success: true },
                    { action: 'تغيير كلمة المرور', timestamp: '2024-01-15 12:15:00', ip: '192.168.1.100', device: 'Chrome Windows', success: true },
                    { action: 'محاولة تسجيل دخول فاشلة', timestamp: '2024-01-15 10:45:00', ip: '192.168.1.101', device: 'Firefox Ubuntu', success: false },
                    { action: 'تفعيل المصادقة الثنائية', timestamp: '2024-01-14 16:20:00', ip: '192.168.1.100', device: 'Chrome Windows', success: true }
                ];
                
                const tableBody = document.getElementById('securityLogsTable');
                tableBody.innerHTML = logs.map(log => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <i data-lucide="${log.success ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${log.success ? 'text-green-600' : 'text-red-600'} ml-2"></i>
                                ${log.action}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-600">${log.timestamp}</td>
                        <td class="px-4 py-3 text-gray-600">${log.ip}</td>
                        <td class="px-4 py-3 text-gray-600">${log.device}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs ${log.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${log.success ? 'نجح' : 'فشل'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading security logs:', error);
            }
        }

        function refreshSecurityLogs() {
            loadSecurityLogs();
        }

        // Backup codes functions
        function downloadBackupCodes() {
            const codes = Array.from(document.querySelectorAll('#backupCodes div')).map(div => div.textContent);
            const content = 'أكواد الاستعادة للمصادقة الثنائية\n\n' + codes.join('\n');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup-codes.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printBackupCodes() {
            const codes = Array.from(document.querySelectorAll('#backupCodes div')).map(div => div.textContent);
            const printContent = `
                <h2>أكواد الاستعادة للمصادقة الثنائية</h2>
                <p>احفظ هذه الأكواد في مكان آمن:</p>
                <ul style="list-style: none; font-family: monospace;">
                    ${codes.map(code => `<li style="margin: 10px 0; padding: 5px; border: 1px solid #ccc;">${code}</li>`).join('')}
                </ul>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Utility functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        function showPasswordChange() {
            document.getElementById('oldPassword').focus();
        }

        function showSecurityLogs() {
            document.getElementById('securityLogsTable').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
