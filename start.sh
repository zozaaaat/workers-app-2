#!/bin/bash

# ๐ ุชุดุบูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงู ุงููุชูุงูู
# ุงููุณุฎุฉ ุงููุชูุฏูุฉ ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุฃูุงู ุงููุชุทูุฑ

echo "๐ ุจุฏุก ุชุดุบูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงู ุงููุชูุงูู..."
echo "=================================================="

# ุงูุชุญูู ูู ูุฌูุฏ Python
if ! command -v python &> /dev/null; then
    echo "โ Python ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Python 3.8 ุฃู ุฃุญุฏุซ"
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ pip
if ! command -v pip &> /dev/null; then
    echo "โ pip ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช pip"
    exit 1
fi

echo "โ ุชู ุงูุนุซูุฑ ุนูู Python ู pip"

# ุฅูุดุงุก ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
if [ ! -d "venv" ]; then
    echo "๐ฆ ุฅูุดุงุก ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ..."
    python -m venv venv
fi

# ุชูุนูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ
echo "๐ง ุชูุนูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ..."
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
    # Windows
    source venv/Scripts/activate
else
    # Linux/Mac
    source venv/bin/activate
fi

# ุชุซุจูุช ุงููุชุทูุจุงุช
echo "๐ ุชุซุจูุช ุงููุชุทูุจุงุช..."
pip install -r requirements.txt

# ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
echo "๐๏ธ ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
if [ ! -f "workers.db" ]; then
    echo "ุฅูุดุงุก ูุงุนุฏุฉ ุจูุงูุงุช ุฌุฏูุฏุฉ..."
fi

# ุชุดุบูู migrations
echo "๐ ุชุดุบูู migrations..."
alembic upgrade head

# ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
echo "โ๏ธ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ..."

# ุชุดุบูู ุณูุฑูุจุช ุฅุนุฏุงุฏ ุงูุฃุฐููุงุช
if [ -f "scripts/setup_permissions.py" ]; then
    echo "๐ ุฅุนุฏุงุฏ ูุธุงู ุงูุฃุฐููุงุช..."
    python scripts/setup_permissions.py
fi

# ุชุดุบูู ุณูุฑูุจุช ุฅูุดุงุก ุงููุณุชุฎุฏููู ุงูุงูุชุฑุงุถููู
if [ -f "scripts/create_default_users.py" ]; then
    echo "๐ฅ ุฅูุดุงุก ุงููุณุชุฎุฏููู ุงูุงูุชุฑุงุถููู..."
    python scripts/create_default_users.py
fi

# ุฅูุดุงุก ูุฌูุฏ ุงูููุงุฐุฌ ููุฐูุงุก ุงูุงุตุทูุงุนู
if [ ! -d "models" ]; then
    echo "๐ค ุฅูุดุงุก ูุฌูุฏ ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู..."
    mkdir models
fi

echo "=================================================="
echo "๐ ุชู ุงูุฅุนุฏุงุฏ ุจูุฌุงุญ! ุงููุธุงู ุฌุงูุฒ ููุชุดุบูู"
echo "=================================================="

# ุชุดุบูู ุงูุฎุงุฏู
echo "๐ ุชุดุบูู ุฎุงุฏู ุงูุชุทุจูู..."
echo ""
echo "๐ ุณูุชู ุชุดุบูู ุงููุธุงู ุนูู:"
echo "   - ุงูุฎุงุฏู ุงูุฑุฆูุณู: http://localhost:8000"
echo "   - ุงูุชูุซูู ุงูุชูุงุนูู: http://localhost:8000/docs"
echo "   - ููุญุฉ ุงูุชุญูููุงุช: http://localhost:8000/analytics-dashboard.html"
echo "   - ุฅุนุฏุงุฏุงุช ุงูุฃูุงู: http://localhost:8000/security-settings.html"
echo "   - ุงูุฐูุงุก ุงูุงุตุทูุงุนู: http://localhost:8000/ai-dashboard.html"
echo ""
echo "๐ฑ ูุชุดุบูู ุชุทุจูู ุงูููุจุงูู:"
echo "   cd mobile-app && npm install && npm start"
echo ""
echo "๐ ูุฅููุงู ุงูุฎุงุฏู: ุงุถุบุท Ctrl+C"
echo "=================================================="

# ุชุดุบูู ุงูุฎุงุฏู ูุน ุฅุนุงุฏุฉ ุงูุชุญููู ุงูุชููุงุฆู
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
